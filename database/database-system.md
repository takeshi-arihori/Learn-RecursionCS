## データベースシステム
メモリは揮発性のためデータを保持するため電力を必要とし、メモリの電源を切るとデータはすぐに失われる。

- データベース管理システム: 機能、物理的特性、論理、プロトコルを一つのソフトウェアツールに抽象化し、データの保存や読み書きを可能にしたシステム。

![database-system](https://github.com/user-attachments/assets/e840682c-2d65-4f4f-acac-a1cf4736d21b)

## データベースの特性

### ファイルシステムでも保存は可能
ファイル処理システムがあることであらゆる種類のデータをローカルストレージに保存し、後から読み出すことができる。
また、データ構造をファイルに格納できるように文字列やビット等の形式に変換するシリアル化や、ファイルを読み込んでメモリ内のオブジェクトに戻す逆シリアル化を行うこともある。

![serialize](https://github.com/user-attachments/assets/25fd2ff3-467d-42a3-b39c-b2e33edf4073)

### ファイルへ保存時に生じる問題(複雑なソフトウェアで発生する問題)
- データ構造の変更や、バックアップはどうするか??
- データの重複、繰り返し構造をどのように回避するのか??
- データの制約をどのようにチェックするのか??
- 複数のクライアントがファイルにアクセスする際のセキュリティや並行性はどうするのか??
- データへのアクセスや分析は簡単で再利用可能なのか??
- ファイルは破損しないのか??読み書きはどうやって拡張する??
※上記の理由からDBMSが必要

- トランザクション処理: データエントリの更新など、状態の変化を表すデータベースシステム内の作業単位のこと。(データの状態を変化させる作業を行う。)
![transaction](https://github.com/user-attachments/assets/55ddc752-4c05-47e9-a8c9-d3d9b35bbfd9)

### データベースシステムの目的
- **利便性**
データベースシステムを使うとあらゆるユーザーがデータに簡単にアクセスし更新することができる。
クエリを使うとユーザーが一定量のデータや特定の種類のデータにしかアクセスできないように制限することができる。
 
- **永続性**
一度コミットされたトランザクションが、システム障害が発生しても、コミットされた状態を維持すること。コンピュータディスクのハードドライブに直接保存するなど不揮発性を持つストレージによって実現される。

- **一貫性と統合性(consistency and integrity)**
  - システム内のデータは特定の情報を参照する異なるセクションが、全て同じデータを参照するように一貫性を保つ必要がある。  
    オンラインショップのユーザーのメールアドレスが記録された場合、そのユーザーの請求書や連絡先、領収書など同じユーザーの電子メールを含み、ユーザーが電子メールを更新したとしてもシステム全体で一貫性が保たれコピーや参照がすべて一致する必要がある。
  - データエントリーは一貫性を保証するために、制約と呼ばれる指定されたルールに従う必要がある。  
    ユーザーの給料を数字で入力する必要があるにもかかわらず文字列が入力された場合、システム性合成エラーを直ちに認識するべき(制約条件に従わない場合は直ちにエラーとなりトランザクションは実行されるべきではない)
  - 統合性に関するルール: 参照チェック等、データベース内の一貫性を維持するために使用。
    エントリーが他のエントリーを識別子(idなど)で参照する場合、チェックを行いidが存在することを保証する必要がある。
    仮に参照しているデータエントリが削除された場合、他の参照を削除または修正するカスケードやロールバックなど、一貫性を保つためのルールが設けられている場合がある。
  - データエントリが入力また更新されると、データベースは以前の状態から新しい状態へと移行する。新しい状態に移行する前に、この新しい状態が有効であることを保証しなければ以前の有効な状態に戻ってしまう。

- **冗長性の低減(reduce redundancy)**
データベースシステムはデータが効率的に整理されているという物理的な特性を持っているため、相互参照が可能になり、不必要な重複を減らし、データベースのストレージ使用料を低く抑えることができる。
冗長性が減ることで、インデックスアルゴリズム等がより強力になり、データへのアクセスをより早く実行することができる。

- **独立性と並行性(isolation and concurrency)**
データベースシステムでは、データを分離・独立させることができる。  
エントリーが入力されると、そのエントリは所定の位置にロックされるか、コミットされる。エントリーを読み込む際にはデータ形式が保障されるので、どのプラットフォームから読んでもシステムは同じデータを読み込むことができる。  
データベースのエントリに対するトランザクションが行われると、それは分離され、完全にコミットされるまで独立して処理される。

- **原子性(Atomicity)**
データベースのトランザクションにおいて、システムの状態を変化させる一連の操作が全体に起こるか、あるいは全く起こらないことを意味する。  
実際の開発では、トランザクションの処理が途中で終わった場合は、前の状態にロールバックすることが通例。  

![rollback](https://github.com/user-attachments/assets/96e8e359-b94b-4244-ae62-35fad7ba2f38)

- **ACID**: データベースシステムの基本で主要な要素。
原子性・一貫性・独立性・永続性

- **セキュリティ(security)**
システムは認証メカニズムを提供し、データがしっかりと管理されるようにする。  

例: ソーシャルメディア上でのトラブル
ユーザーがサポートチケットを消費して、サポートデスクへ連絡 -> ユーザーの設定など特定のデータにアクセス可能だが、その他のプライベートな内容にはアクセス不可。  
各データベースユーザーがアクセスできるものをフィルタリングすることができる。  

![security](https://github.com/user-attachments/assets/c6b2b0c9-5cf2-4284-9db8-5e2dd09a3014)

## データベースの内部

- **クエリプロセッサー**: データベース言語を解釈し、低階層の命令にコンパイルする役割を担っている。
- **データベース言語**: データベースを操作するための言語。ほとんどの場合、SQL(structured query language)言語が採用されている。
  - データ定義言語(DDL data-definition language)
  - データ操作言語(DML data-manipulation language)
- **スキーマ**: 保存されているデータの集合体に紐づけられている全ての規則のことを指す。
  格納するデータ型、使用する物理的データ構造、データエントリの整合性と制約、承認ルールの宣言などが含まれる。
  ※誰がデータベースにデータを保存したり読み出したりできるか、どのようにデータを保存するのかを決定する。

![schema](https://github.com/user-attachments/assets/ffe39ea0-dbc8-4ec9-a56c-568f6b01062e)

- **インスタンス**: ある特定の時点でのシステム内に存在する実際のデータ
OOPの観点からは、スキーマは「クラスの設計図」、データベースのインスタンスは「ある時点で特定の状態にあるオブジェクト(クラスのインスタンス)」

![ddl-interpreter](https://github.com/user-attachments/assets/55d107b0-4dc8-4044-9c02-2fb493c49448)

- **ストレージマネージャ**: オペレーティングシステムの低階層I/O(Input/Ooutput API)と通信することで、データをコンピュータ内のファイルとして保存する役割を果たす。
バイナリファイルのようにオペレーティングシステム階層でコンピュータに保存されているものと、クエリプロセッサが生成する命令との間を繋ぐ役割を担う。
データに素早くアクセスできるルックアップテーブルのように、インデックスのセットを管理することができる。平衡二分探索木として実装される。

### ストレージマネージャ内
- **Authorization manager**: ユーザーがデータにアクセスする権限を持っているかどうかをデータベースのデータ辞書を参照してチェックする。
- **Integrity manager**: 状態の変更がスキーマで指定された制約と参照の生合成に従うかどうかをチェックする。
- **File manager**: ディスクストレージ内のデータ構造を決定し、ディスクストレージ内のデータの割り当てを行う。
- **Buffer manager**: メインメモリーに何をキャッシュするかを決定し、ディスクからメインメモリーへのデータの取り込みを行う。
- **Transaction manager**: データベースのトランザクション内で必要な手続きを行う。
同時実行時の一貫性の維持、ロールバックの仕組み、原子性のルールの適用など。
リレーショナルデータベースでは、ACID(原子性、一貫性、独立性、永続性)ルールが適用される。

![authorization-manager](https://github.com/user-attachments/assets/b17e5c5c-4d84-48bc-84f8-14131e370bcd)

### データベースシステム内の3つの異なる階層

![database-level](https://github.com/user-attachments/assets/823515e6-6fa5-44e7-81a7-299ca7675040)

- **物理層(physical level)**: データが物理的にどのように保存されるかを決定する。
  - データ型は何バイトか?
  - ファイル内の記号を解析する際、区切り文字は必要か??
  - 使用すべきデータ構造は何か??
  - 何をどのような方法でインデックス化するか??
- **論理層(logical level)**: スキーマ設計のように、データベースが高階層でどのように構成されているかを表す。
  - テーブル(データ集)にはどのようなデータ型を束ねるべきか??
  - 制約や整合性のルールは何か??
  - 他のテーブルのキーなど、参照すべきものはあるか(外部キーなど)??
  - データベース全体のデータ関係はどうなっているか??
- **外部層(View level)**: データベースの一部のみを表す。データベース管理者が設定するものでセキュリティ上の目的や複雑度を軽減するためのもの。

## データベースアーキテクチャ
![system-structure](https://github.com/user-attachments/assets/de299de4-1982-422a-b935-946ae217d7ee)

## データベースモデル
要求事項をよく吟味し、高い階層を持つデータモデルを作成することが推奨されている -> 機能要件と非機能要件を整理し、システムのデータ要件を適切に作成。  

### データベーススキーマの設計
DBMSにはDDLコマンドでスキーマを更新できる柔軟性がある。  

### データモデルを選択
- どのような概念を適用すべきか
- 要件をデータベースモデルに適合する設計にどのように変換するか
※設計段階ではまず論理層に焦点を当てることが重要

### 4つのデータベースシステム
データベースモデル: データベースに共通して適用されるデータモデルで、データの論理構造や、データの整理・保存・操作の方法を決定するもの  

**関係モデル**: データと関係をテーブルで表現する。テーブルはリレーションと呼ばれ、データエントリを表すタプルと呼ばれる行と、タプルの要素がどのようなデータタイプであるかを指定する属性を呼ばれる列を含む。(行のエントリ形式はテーブル内では常に固定)  

- **リレーショナルデータベース**
関係モデルを用いてデータを構造化するデータベースに与えられる名称。構造と豊富な機能を備えており、ACID(原始性、一貫性、独立性、永続性)の特徴を保証していることが最大の売り。
![relational-database](https://github.com/user-attachments/assets/9f4d70ae-ecbb-416f-bd25-ae58ab94c5c6)

- **実態関連データモデル**
エンティティと呼ばれる基本的なオブジェクトの集合体を使用し、エンティティ間の関係を記述する。ER図は、現実世界やビジネスの観点からデータを見てオブジェクトを互いに区別し、関係を指定するために使用される。
ER図を使うと、データベースの設計がしやすくなったり、設計をスキーマへ変換しやすくなる。  
![entity-relationship-data-model](https://github.com/user-attachments/assets/b365ecb2-7591-46e1-b3ed-9ec5a84fac27)

- **半構造化データモデル**
同じデータ型のエントリが異なる属性のセットを持つことができるデータモデルのこと。スキーマで指定された固定のカラム(属性)を強制する関係モデルとは異なる。
key valueペアで保存され、NoSQLデータベースと呼ばれることもある。構造を持たないためACIDの特徴は保証されない。
以下の特徴のため拡張性の高いソフトウェアに頻繁に使用される傾向にある。(redis, mongodb, cassandraなど)
**特徴**
  - 読み込み速度: RDSと一緒
  - 書き込み効率: NoSQLの方が高い

![semi-structured-data-model](https://github.com/user-attachments/assets/dcbfee82-dc17-4707-9cf5-933f49fd7b7f)


- **オブジェクトモデル**
データをオブジェクトになぞらえてモデル化したデータモデルのこと。
スキーマがクラスの設計図に近い役割を果たし、データエントリはある時点でのオブジェクトの状態であることを意味する。
オブジェクトモデルのニーズを満たす特定のデータベースや、ORMのように、データベースのエントリをマッピングし、実行時のオブジェクトに変換するツールもある。
![object-model](https://github.com/user-attachments/assets/3b5fad3f-fd2c-4918-8279-5a074e6cfa78)

